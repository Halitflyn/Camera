<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–∫–∞–ª—å–Ω–∞ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            text-align: center;
        }

        h1 {
            color: #007bff;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–∫—Ü—ñ—ó –∫–∞–º–µ—Ä–∏ */
        #camera-setup {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #video-stream {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #007bff;
            border-radius: 4px;
            display: block;
            margin: 0 auto 20px;
        }
        
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #capture-button {
            background-color: #28a745;
            color: white;
        }
        #capture-button:hover {
            background-color: #218838;
        }
        
        #switch-camera-button {
            background-color: #007bff;
            color: white;
        }
        #switch-camera-button:hover {
            background-color: #0056b3;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –≥–∞–ª–µ—Ä–µ—ó */
        #gallery-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding-top: 20px;
        }

        .photo-card {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            width: 220px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .photo-card img {
            width: 200px; /* –ú—ñ–Ω—ñ–∞—Ç—é—Ä–∞ */
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .photo-card .photo-title {
            font-weight: bold;
            margin-bottom: 10px;
            word-break: break-all;
            text-align: center;
        }

        .photo-card .actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .actions .delete-btn { background-color: #dc3545; color: white; }
        .actions .delete-btn:hover { background-color: #c82333; }
        .actions .edit-btn { background-color: #ffc107; color: #333; }
        .actions .edit-btn:hover { background-color: #e0a800; }
        .actions .move-btn { background-color: #007bff; color: white; }
        .actions .move-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <h1>üì∏ –õ–æ–∫–∞–ª—å–Ω–∞ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è</h1>
    
    <hr>

    <div id="camera-setup">
        <h2>1. –ö–∞–º–µ—Ä–∞</h2>
        
        <video id="video-stream" autoplay playsinline></video>
        <canvas id="canvas-capture" style="display:none;"></canvas>

        <div id="controls">
            <button id="capture-button" disabled>–ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
            <button id="switch-camera-button" disabled>–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É üîÑ</button>
        </div>
    </div>

    <hr>

    <div id="gallery-section">
        <h2>2. –í–∞—à–∞ –ì–∞–ª–µ—Ä–µ—è</h2>
        <div id="gallery-container">
            <p id="no-photos-message">–£ –≥–∞–ª–µ—Ä–µ—ó –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ñ–æ—Ç–æ. –ó—Ä–æ–±—ñ—Ç—å –ø–µ—Ä—à–∏–π –∑–Ω—ñ–º–æ–∫!</p>
        </div>
    </div>

    <script>
        // –Ü–º–µ–Ω–∞ —Å—Ö–æ–≤–∏—â
        const STORAGE_KEY = 'localPhotoGallery';
        
        // DOM-–µ–ª–µ–º–µ–Ω—Ç–∏
        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('canvas-capture');
        const captureButton = document.getElementById('capture-button');
        const switchCameraButton = document.getElementById('switch-camera-button');
        const galleryContainer = document.getElementById('gallery-container');
        const noPhotosMessage = document.getElementById('no-photos-message');

        let currentCameraId = null; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –ø–æ—Ç–æ—á–Ω–æ—ó –∫–∞–º–µ—Ä–∏
        let cameras = []; // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏–º–µ–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞–º–µ—Ä

        // --- 1. –î–û–°–¢–£–ü –î–û –ö–ê–ú–ï–†–ò –Ü –ó–ô–û–ú–ö–ê ---

        async function getCameras() {
            try {
                // –ó–∞–ø–∏—Ç –¥–æ–∑–≤–æ–ª—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –º—ñ—Ç–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ (label)
                await navigator.mediaDevices.getUserMedia({ video: true }); 

                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');

                if (cameras.length > 1) {
                    switchCameraButton.disabled = false;
                } else {
                    switchCameraButton.disabled = true;
                }

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π ID: —è–∫—â–æ –∫–∞–º–µ—Ä –±–∞–≥–∞—Ç–æ, –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ "–∑–∞–¥–Ω—é" (environment), —ñ–Ω–∞–∫—à–µ –±–µ—Ä–µ–º–æ –ø–µ—Ä—à—É
                const environmentCamera = cameras.find(cam => cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('environment'));
                currentCameraId = environmentCamera ? environmentCamera.deviceId : (cameras[0] ? cameras[0].deviceId : null);

            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Å–ø–∏—Å–∫—É –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –∞–±–æ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ', err);
                // –ó–∞–ª–∏—à–∞—î–º–æ currentCameraId = null, —â–æ–± startCamera —Å–ø—Ä–æ–±—É–≤–∞–ª–∞ –∑ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–º–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è–º–∏
            }
        }

        async function startCamera() {
            if (video.srcObject) {
                // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–æ—Ç—ñ–∫
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            // –ù–∞–º–∞–≥–∞—î–º–æ—Å—è –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –±–∞–∂–∞–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è (–±–∞–∂–∞–Ω—É –∫–∞–º–µ—Ä—É)
            const constraints = {
                video: {
                    deviceId: currentCameraId ? { exact: currentCameraId } : undefined 
                }
            };
            
            // –Ø–∫—â–æ currentCameraId –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ "video: true"
            if (!currentCameraId && cameras.length === 0) {
                 constraints.video = true;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await video.play();
                captureButton.disabled = false;
                captureButton.textContent = '–ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ';
                
                // –Ø–∫—â–æ currentCameraId —â–µ –Ω–µ –±—É–ª–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –æ–Ω–æ–≤–ª—é—î–º–æ –π–æ–≥–æ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É
                if (!currentCameraId) {
                    const track = stream.getVideoTracks()[0];
                    currentCameraId = track.getSettings().deviceId;
                    console.log("–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ –∑ ID:", currentCameraId);
                }

            } catch (err) {
                console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏: ', err);
                captureButton.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ üòü';
                alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏.');
            }
        }

        function switchCamera() {
            if (cameras.length < 2) return;

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω–¥–µ–∫—Å –ø–æ—Ç–æ—á–Ω–æ—ó –∫–∞–º–µ—Ä–∏
            const currentIndex = cameras.findIndex(cam => cam.deviceId === currentCameraId);
            
            // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —ñ–Ω–¥–µ–∫—Å –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–∞–º–µ—Ä–∏ –ø–æ –∫–æ–ª—É
            const nextIndex = (currentIndex + 1) % cameras.length;
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ID –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–∞–º–µ—Ä–∏
            currentCameraId = cameras[nextIndex].deviceId;

            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞–º–µ—Ä—É –∑ –Ω–æ–≤–∏–º ID
            startCamera();
        }

        function capturePhoto() {
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ä–æ–∑–º—ñ—Ä—ñ–≤ –≤—ñ–¥–µ–æ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // –ú–∞–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–∞–¥—Ä –Ω–∞ canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // –û—Ç—Ä–∏–º—É—î–º–æ Data URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ JPEG –¥–ª—è –º–µ–Ω—à–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É)
            const photoDataURL = canvas.toDataURL('image/jpeg', 0.8); 

            const photo = {
                id: Date.now(),
                name: `–§–æ—Ç–æ-${new Date().toLocaleTimeString('uk-UA')}`,
                data: photoDataURL
            };

            savePhoto(photo);
            renderGallery();

            alert('–§–æ—Ç–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }

        captureButton.addEventListener('click', capturePhoto);
        switchCameraButton.addEventListener('click', switchCamera);


        // --- 2. –†–û–ë–û–¢–ê –ó LOCAL STORAGE ---

        function getPhotos() {
            const photosJSON = localStorage.getItem(STORAGE_KEY);
            return photosJSON ? JSON.parse(photosJSON) : []; 
        }

        function savePhotos(photosArray) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(photosArray));
        }

        function savePhoto(newPhoto) {
            const photos = getPhotos();
            // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–µ —Ñ–æ—Ç–æ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –º–∞—Å–∏–≤—É
            photos.unshift(newPhoto); 
            savePhotos(photos);
        }

        // --- 3. –û–ù–û–í–õ–ï–ù–ù–Ø –ì–ê–õ–ï–†–ï–á –¢–ê –§–£–ù–ö–¶–Ü–û–ù–ê–õ ---

        function renderGallery() {
            const photos = getPhotos();
            galleryContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –≥–∞–ª–µ—Ä–µ—é

            if (photos.length === 0) {
                noPhotosMessage.style.display = 'block';
                return;
            } else {
                noPhotosMessage.style.display = 'none';
            }

            photos.forEach((photo, index) => {
                const card = createPhotoCard(photo, index, photos.length);
                galleryContainer.appendChild(card);
            });
        }

        function createPhotoCard(photo, index, totalPhotos) {
            const card = document.createElement('div');
            card.className = 'photo-card';
            card.dataset.id = photo.id;
            
            card.innerHTML = `
                <div class="photo-title">${photo.name}</div>
                <img src="${photo.data}" alt="${photo.name}">
                <div class="actions">
                    <button class="edit-btn">üìù –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                    <button class="delete-btn">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    <button class="move-btn" data-direction="left" ${index === 0 ? 'disabled' : ''}>‚óÄÔ∏è</button>
                    <button class="move-btn" data-direction="right" ${index === totalPhotos - 1 ? 'disabled' : ''}>‚ñ∂Ô∏è</button>
                </div>
            `;
            
            card.querySelector('.delete-btn').addEventListener('click', () => deletePhoto(photo.id));
            card.querySelector('.edit-btn').addEventListener('click', () => editPhotoName(photo.id, photo.name));
            card.querySelectorAll('.move-btn').forEach(btn => {
                btn.addEventListener('click', (e) => movePhoto(photo.id, e.target.dataset.direction));
            });

            return card;
        }

        function deletePhoto(id) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ —Ñ–æ—Ç–æ?')) {
                let photos = getPhotos();
                photos = photos.filter(photo => photo.id !== id);
                savePhotos(photos);
                renderGallery();
            }
        }

        function editPhotoName(id, currentName) {
            const newName = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –Ω–∞–∑–≤—É –¥–ª—è —Ñ–æ—Ç–æ:', currentName);
            if (newName && newName.trim() !== currentName) {
                let photos = getPhotos();
                const photoIndex = photos.findIndex(photo => photo.id === id);

                if (photoIndex !== -1) {
                    photos[photoIndex].name = newName.trim();
                    savePhotos(photos);
                    renderGallery();
                }
            }
        }

        function movePhoto(id, direction) {
            let photos = getPhotos();
            const photoIndex = photos.findIndex(photo => photo.id === id);

            if (photoIndex === -1) return;

            let newIndex = photoIndex;

            if (direction === 'left' && photoIndex > 0) {
                newIndex = photoIndex - 1;
            } else if (direction === 'right' && photoIndex < photos.length - 1) {
                newIndex = photoIndex + 1;
            } else {
                return;
            }

            // –ó–º—ñ–Ω—é—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –º—ñ—Å—Ü—è–º–∏
            [photos[photoIndex], photos[newIndex]] = [photos[newIndex], photos[photoIndex]];

            savePhotos(photos);
            renderGallery();
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        window.addEventListener('load', async () => {
            // –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            await getCameras();
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞–º–µ—Ä—É (–≤–∏–±–∏—Ä–∞—î—Ç—å—Å—è –∑–∞–¥–Ω—è, —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞)
            startCamera();
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –≥–∞–ª–µ—Ä–µ—é
            renderGallery();
        });

    </script>
</body>
</html>
